# newrelic-spam
New Relic plugin to parse Nginx's rate limiting logs and send the data to New Relic.

## How it works

This New Relic plugin parses the logs generated by Nginx's **ngx_http_limit_req_module** and reports
the metrics to New Relic.

The plugin checks the log files every 60 seconds and parses all the logs for the current minute by grepping with
the following command:

```
/bin/egrep "2017/03/20 10:15.*(delaying|limiting) request" error.log
```

The results outputed by grep are then processed in Java and sent to New Relic. The following metrics are recorded:
* Total number of requests delayed or blocked.
* Number of unique ipv4 addresses.
* Number of unique ipv6 addresses.
* Number of POST requests delayed or blocked.
* Number of PUT requests delayed or blocked.
* Number of DELETE requests delayed or blocked.
* Number of unique endpoints delayed or blocked.

## Installation

* Create a directory and place plugin.jar inside.
* Copy the *templates/config* directory to the directory you just created.
* Copy *newrelic.template.json* to *newrelic.json* and adapt the values.
* Copy *plugin.template.json* to *plugin.json* and adapt the values.
* Copy the systemd service file *newrelic-spam-monitor.service* to */etc/systemd/system* and adapt the values.
* Enable the service with ```systemctl enable newrelic-nginx-spam ```.
* Start the service with ```systemctl start newrelic-nginx-spam```.

## Configuration

There are two configuration files that need to be edited, the standard *config/newrelic.json* where
the license key should be added, and *config/plugin.json* where the following parameters can be configured:

* **name**: the name of the server on New Relic.
* **logFile**: Location of the file where Nginx logs the blocked or delayed requests.
* **dateFormat**: Java's DateFormat syntax to parse the date from the Nginx logs.
* **patternMethod**: Regex to parse the HTTP Method from the Nginx logs.
* **patternIpv4**: Regex to parse the client Ipv4 address from the Nginx logs.
* **patternIpv6**: Regex to parse the client Ipv6 address from the Nginx logs.
* **patternEndpoint**: Regex to parse the endpoint of the request from the Nginx logs.

With the default Nginx configuration a delayed request might look like this:

```
2017/03/24 14:38:21 [warn] *4999568 delaying request, excess: 0.095, by zone "myzone", client: 11.11.11.11,
server: _, request: "POST /myendpoint HTTP/1.1", host: "doodle.com"
```

Therefore a configuration to parse these logs might look like this:

```
{
  "agents": [
    {
      "name": "Entry server 1",
      "logFile" : "/var/log/nginx/error.log",
      "dateFormat" : "yyyy/MM/dd HH:mm",
      "patternMethod" : "request: \"(GET|POST|PUT|DELETE)",
      "patternIpv4" : "client: ([0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}),",
      "patternIpv6" : "client: (\\w*:\\w*:\\w*:\\w*:\\w*:\\w*),",
      "patternEndpoint" : "(GET|POST|PUT|DELETE) (/.*) HTTP"
    }
  ]
}
```
